name: XAlgo Autobot CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  xalgo-ci:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v3

    - name: 🐍 Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 📁 Confirm directory structure
      run: ls -R

    - name: 📦 Install dependencies
      run: |
        python -m venv .venv
        source .venv/bin/activate
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: 🧪 Run test suite
      run: |
        source .venv/bin/activate
        if [ -f xalgo_cli_runner.py ]; then
          python xalgo_cli_runner.py test
        else
          echo "❌ File not found: xalgo_cli_runner.py"
          exit 1
        fi

    - name: 🧠 Train ML Filter Model
      run: |
        source .venv/bin/activate
        python src/tools/train_ml_filter_combined.py

    - name: 🤖 Commit updated ML model if changed
      run: |
        git config --global user.name "xalgo-autobot"
        git config --global user.email "autobot@xalgonexus.com"
        git add ml_model/triangular_rf_model.pkl || true
        git commit -m "🤖 Auto-trained triangular_rf_model.pkl [CI]" || echo "No changes to commit"
        git push || echo "No changes to push"

    - name: 📊 Validate Prometheus Metrics
      run: |
        source .venv/bin/activate
        python -c "import requests; \
try: \
    r = requests.get('http://localhost:9100/metrics', timeout=3); \
    if 'xalgo_latest_spread' in r.text: \
        print('✅ Prometheus metrics found.'); \
    else: \
        print('⚠️ Metrics responded, but expected metric not found.'); \
except Exception as e: \
    print(f'⚠️ Prometheus check skipped: {e}')"

    - name: 🗂 Archive logs as PDF
      run: |
        pip install fpdf
        python tools/archive_logs.py

    - name: 📚 Generate README_AUTO.md
      run: |
        source .venv/bin/activate
        python scripts/gen_docs.py

    - name: ✅ Done
      run: echo "🚀 XAlgo CI completed successfully!"
