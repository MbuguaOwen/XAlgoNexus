name: Auto Monitoring Config Sync

on:
  workflow_dispatch:
  push:
    paths:
      - prometheus.yml
      - alert.rules.yml
      - alertmanager.yml
      - grafana/**
      - src/tools/train_ml_filter_combined.py
      - ml_model/**
      - .github/workflows/auto-monitoring-sync.yml

jobs:
  sync-monitoring-stack:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config user.name "XAlgo Sync Bot"
          git config user.email "xalgo-bot@example.com"

      - name: Stage monitoring and ML files
        run: |
          git add prometheus.yml alert.rules.yml alertmanager.yml || true
          git add grafana/provisioning/datasources/* grafana/provisioning/dashboards/* || true
          git add src/tools/train_ml_filter_combined.py || true
          git add ml_model/* || true

      - name: Commit if changes exist
        id: commit
        run: |
          if git diff --cached --quiet; then
            echo "No changes to commit."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            git commit -m "üîß Sync monitoring config and ML model [bot]"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Push changes
        if: steps.commit.outputs.skip != 'true'
        run: git push

      - name: Set PYTHONPATH to include ./src
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE/src" >> $GITHUB_ENV

       

      - name: Run ML Filter Training
        run: |
          python src/tools/train_ml_filter_combined.py || echo "‚ö†Ô∏è ML training failed but workflow continued."

      - name: Tag release
        if: steps.commit.outputs.skip != 'true'
        run: |
          VERSION_TAG="monitoring-v1"
          if git tag | grep -q "^$VERSION_TAG$"; then
            VERSION_TAG="${VERSION_TAG}-$(date +%s)"
          fi
          git tag "$VERSION_TAG"
          git push origin "$VERSION_TAG"
